name: 'Visual Regression'

on:
    workflow_dispatch:
        inputs:
            components:
                description: 'Comma-separated component names to test (empty = auto-detect)'
                required: false
                type: string
    pull_request:
        types:
            - opened
            - synchronize
        paths:
            - packages/core/**

permissions:
    id-token: write
    contents: read

env:
    BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
    AWS_REGION: ${{ secrets.AWS_REGION }}
    AWS_IAM_ROLE_NAME: ${{ secrets.AWS_IAM_ROLE_NAME }}
    AWS_IAM_ROLE_SESSION_NAME: ${{ secrets.AWS_IAM_ROLE_SESSION_NAME }}
    REPORT_PATH: ''
    TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    TURBO_TEAM: ${{ vars.TURBO_TEAM }}

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
    cancel-in-progress: true

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            affected_components: ${{ steps.detect.outputs.components }}
            should_run_all: ${{ steps.detect.outputs.run_all }}
            skip_tests: ${{ steps.detect.outputs.skip }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect affected components
              id: detect
              run: |
                  # Use manual input if provided
                  if [ -n "${{ github.event.inputs.components }}" ]; then
                      echo "components=${{ github.event.inputs.components }}" >> $GITHUB_OUTPUT
                      echo "run_all=false" >> $GITHUB_OUTPUT
                      echo "skip=false" >> $GITHUB_OUTPUT
                      exit 0
                  fi

                  chmod +x ./scripts/detect-affected-components.sh
                  RESULT=$(./scripts/detect-affected-components.sh)
                  echo "Detected components: $RESULT"
                  echo "components=$RESULT" >> $GITHUB_OUTPUT

                  if echo "$RESULT" | grep -q "ALL"; then
                      echo "run_all=true" >> $GITHUB_OUTPUT
                  else
                      echo "run_all=false" >> $GITHUB_OUTPUT
                  fi

                  if [ -z "$RESULT" ] || [ "$RESULT" = "NONE" ]; then
                      echo "skip=true" >> $GITHUB_OUTPUT
                  else
                      echo "skip=false" >> $GITHUB_OUTPUT
                  fi

    build-storybook:
        needs: detect-changes
        if: needs.detect-changes.outputs.skip_tests != 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Dependencies
              uses: ./.github/composite/install

            - name: Build Storybook (with Turbo cache)
              run: pnpm turbo build:storybook

            - name: Upload storybook-static
              uses: actions/upload-artifact@v4
              with:
                  name: storybook-static
                  path: apps/storybook/storybook-static
                  retention-days: 1

    test:
        needs: [detect-changes, build-storybook]
        if: needs.detect-changes.outputs.skip_tests != 'true'
        runs-on: macos-latest
        strategy:
            fail-fast: false
            matrix:
                shard:
                    [
                        { name: firefox, project: firefox },
                        { name: safari, project: webkit },
                        { name: chrome, project: chromium },
                        { name: edge, project: chromium },
                    ]

        steps:
            - name: Git clone the repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Dependencies
              uses: ./.github/composite/install

            - name: Download storybook-static
              uses: actions/download-artifact@v4
              with:
                  name: storybook-static
                  path: apps/storybook/storybook-static

            - name: Install Playwright Browsers
              run: pnpm core exec playwright install ${{ matrix.shard.project }}

            - name: Run Playwright tests
              env:
                  COMPONENT: ${{ needs.detect-changes.outputs.should_run_all == 'true' && '' || needs.detect-changes.outputs.affected_components }}
              run: |
                  if [ -n "$COMPONENT" ]; then
                      echo "Running tests for components: $COMPONENT"
                  else
                      echo "Running all tests"
                  fi
                  pnpm test:regressions -- --project="${{ matrix.shard.name }}"

            - name: Upload blob report to GitHub Actions Artifacts
              if: ${{ !cancelled() }}
              uses: actions/upload-artifact@v4
              with:
                  name: blob-report-${{ matrix.shard.name }}
                  path: packages/core/blob-report
                  retention-days: 1

    merge-reports:
        if: ${{ !cancelled() && needs.build-storybook.result != 'skipped' }}
        needs: [detect-changes, build-storybook, test]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Dependencies
              uses: ./.github/composite/install

            - name: Download blob reports from GitHub Actions Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: all-blob-reports
                  pattern: blob-report-*
                  merge-multiple: true

            - name: Merge into HTML Report
              run: pnpm core exec playwright merge-reports -c ./playwright.merge.ts ../../all-blob-reports

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ env.AWS_IAM_ROLE_NAME }}
                  role-session-name: ${{ env.AWS_IAM_ROLE_SESSION_NAME }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Set report path
              run: |
                  FORMATTED_BRANCH_NAME=$(echo "${{ github.ref_name }}" | tr '/' '-')
                  echo "REPORT_PATH=${FORMATTED_BRANCH_NAME}" >> $GITHUB_ENV

            - name: Upload Report to S3
              run: |
                  aws s3 rm s3://${{ env.BUCKET_NAME }}/${{ env.REPORT_PATH }} --recursive
                  aws s3 cp './packages/core/__tests__/report/' s3://${{ env.BUCKET_NAME }}/${{ env.REPORT_PATH }} --recursive

            - name: Post Test Result
              id: playwright-summary
              uses: daun/playwright-report-summary@v3
              with:
                  report-file: ./packages/core/__tests__/report/index.json
                  report-url: http://${{ env.BUCKET_NAME }}/${{ env.REPORT_PATH }}/index.html
                  create-comment: false

            - name: Parse test results
              id: parse-results
              run: |
                  # Parse the summary output to extract test statistics
                  SUMMARY="${{ steps.playwright-summary.outputs.summary }}"

                  # Extract passed count
                  PASSED=$(echo "$SUMMARY" | grep -oE '\*\*[0-9]+ passed\*\*' | grep -oE '[0-9]+' || echo "0")

                  # Extract failed count
                  FAILED=$(echo "$SUMMARY" | grep -oE '\*\*[0-9]+ failed\*\*' | grep -oE '[0-9]+' || echo "0")

                  # Calculate total
                  TOTAL=$((PASSED + FAILED))

                  # Extract duration
                  DURATION_RAW=$(echo "$SUMMARY" | grep -oE '[0-9]+ minute[s]?, [0-9]+ second[s]?' | head -1 || echo "Unknown")

                  # Format duration
                  if [[ "$DURATION_RAW" != "Unknown" ]]; then
                      MINUTES=$(echo "$DURATION_RAW" | grep -oE '[0-9]+' | head -1)
                      SECONDS=$(echo "$DURATION_RAW" | grep -oE '[0-9]+' | tail -1)
                      DURATION="${MINUTES}m ${SECONDS}s"
                  else
                      DURATION="Unknown"
                  fi

                  echo "passed=$PASSED" >> $GITHUB_OUTPUT
                  echo "failed=$FAILED" >> $GITHUB_OUTPUT
                  echo "total=$TOTAL" >> $GITHUB_OUTPUT
                  echo "duration=$DURATION" >> $GITHUB_OUTPUT

            - name: Generate comment message
              id: comment-message
              run: |
                  COMPONENTS="${{ needs.detect-changes.outputs.affected_components }}"
                  RUN_ALL="${{ needs.detect-changes.outputs.should_run_all }}"

                  if [ "$RUN_ALL" = "true" ] || [ -z "$COMPONENTS" ]; then
                      echo "scope=All components" >> $GITHUB_OUTPUT
                  else
                      echo "scope=$COMPONENTS" >> $GITHUB_OUTPUT
                  fi

            - uses: marocchino/sticky-pull-request-comment@v2
              with:
                  message: |
                      ${{ contains(needs.test.result, 'failure') && format('ðŸš« **{0} tests failed!**', steps.parse-results.outputs.failed) || 'âœ… **All tests passed!**' }}

                      **Tested:** ${{ steps.comment-message.outputs.scope }}

                      | Tests | Passed | Failed | Duration | Report |
                      | :---- | :----- | :----- | :------- | :----- |
                      | ${{ steps.parse-results.outputs.total }} | ${{ steps.parse-results.outputs.passed }} | ${{ steps.parse-results.outputs.failed }} | ${{ steps.parse-results.outputs.duration }} | [Open report â†—ï¸Ž](http://${{ env.BUCKET_NAME }}/${{ env.REPORT_PATH }}/index.html) |

                      [Click here](https://github.com/goorm-dev/vapor-ui/actions/workflows/update-snapshots.yml) if you need to update snapshots.

                  GITHUB_TOKEN: ${{ secrets.VAPOR_BOT_TOKEN }}
